<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legislative Bill Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,500;8..60,700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f7f7f4;
      --ink: #1f2328;
      --muted: #5c6470;
      --card: #ffffff;
      --line: #d8d9d4;
      --accent: #2f6f68;
      --support: #1f7a5e;
      --oppose: #b04a3a;
      --neutral: #6b7280;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "IBM Plex Sans", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(800px 500px at 10% 10%, rgba(47, 111, 104, 0.08), transparent 60%),
        radial-gradient(700px 450px at 90% 0%, rgba(31, 122, 94, 0.06), transparent 55%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 3rem 1.5rem 4rem;
    }

    header {
      display: grid;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    h1 {
      font-family: "Source Serif 4", serif;
      font-size: clamp(2rem, 3vw, 2.6rem);
      letter-spacing: 0.01em;
    }

    .subtitle {
      color: var(--muted);
      font-size: 1rem;
      max-width: 56ch;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      align-items: center;
      margin: 1.5rem 0 2rem;
      padding: 1rem 1.25rem;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(6px);
    }

    .counts {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .count-pill {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-btn.active,
    .filter-btn:hover {
      color: var(--ink);
      border-color: var(--accent);
      box-shadow: 0 6px 14px rgba(31, 35, 40, 0.08);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.25rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1.25rem;
      display: grid;
      gap: 0.75rem;
      box-shadow: 0 10px 30px rgba(25, 28, 32, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: baseline;
    }

    .bill-id {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--ink);
    }

    .author {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .meta {
      display: grid;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .meta strong {
      color: var(--ink);
      font-weight: 600;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .badge {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--line);
      color: var(--muted);
      background: #fafafa;
    }

    .badge.support {
      color: var(--support);
      border-color: rgba(31, 122, 94, 0.35);
      background: rgba(31, 122, 94, 0.08);
    }

    .badge.oppose {
      color: var(--oppose);
      border-color: rgba(176, 74, 58, 0.35);
      background: rgba(176, 74, 58, 0.08);
    }

    .badge.neutral {
      color: var(--neutral);
    }

    details {
      border-top: 1px solid var(--line);
      padding-top: 0.75rem;
      color: var(--muted);
      font-size: 0.9rem;
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }

    .status {
      text-transform: capitalize;
    }

    .empty {
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      border: 1px dashed var(--line);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.6);
    }

    @media (max-width: 720px) {
      .controls {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Legislative Bill Dashboard</h1>
      <p class="subtitle">
        Daily calendar overview for office review. Each card includes committee votes, fiscal
        note flags, and caucus/TCC/TFR positions for quick decision support.
      </p>
    </header>

    <section class="controls">
      <div class="counts" id="counts"></div>
      <div class="filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="support">Caucus Support</button>
        <button class="filter-btn" data-filter="oppose">Caucus Oppose</button>
      </div>
    </section>

    <section>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" hidden>No bills match this filter.</div>
    </section>
  </div>

  <script>
    const INLINE_CSV = "";
    const CSV_PATH = "bill-data-0528.csv";
    const BILL_RE = /^(SB|HB|HR|SR|HJR|SJR|SCR|HCR)\s*\d+/i;

    const countsEl = document.getElementById("counts");
    const gridEl = document.getElementById("grid");
    const emptyEl = document.getElementById("empty");
    const filterButtons = Array.from(document.querySelectorAll(".filter-btn"));

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i += 1) {
        const char = text[i];
        const next = text[i + 1];

        if (inQuotes) {
          if (char === "\"" && next === "\"") {
            field += "\"";
            i += 1;
          } else if (char === "\"") {
            inQuotes = false;
          } else {
            field += char;
          }
        } else {
          if (char === "\"") {
            inQuotes = true;
          } else if (char === ",") {
            row.push(field);
            field = "";
          } else if (char === "\n") {
            row.push(field);
            rows.push(row);
            row = [];
            field = "";
          } else if (char !== "\r") {
            field += char;
          }
        }
      }
      if (field.length || row.length) {
        row.push(field);
        rows.push(row);
      }
      return rows;
    }

    function cleanStatus(value) {
      if (!value) return "";
      return value.replace(/\s+/g, " ").trim();
    }

    function statusClass(status) {
      const lower = status.toLowerCase();
      if (lower.includes("support")) return "support";
      if (lower.includes("oppose")) return "oppose";
      return "neutral";
    }

    function escapeHTML(value) {
      return value
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatMultiline(text) {
      return escapeHTML(text).replace(/\n/g, "<br>");
    }

    function buildCard(bill) {
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.caucus = bill.caucusClass;

      const header = document.createElement("div");
      header.className = "card-header";
      header.innerHTML = `
        <div>
          <div class="bill-id">${escapeHTML(bill.bill)}</div>
          <div class="author">${escapeHTML(bill.author)}</div>
        </div>
      `;

      const badges = document.createElement("div");
      badges.className = "badges";
      badges.innerHTML = `
        <span class="badge ${bill.caucusClass}">Caucus: <span class="status">${escapeHTML(bill.caucus || "Not set")}</span></span>
        <span class="badge ${statusClass(bill.tcc)}">TCC: <span class="status">${escapeHTML(bill.tcc || "Not set")}</span></span>
        <span class="badge ${statusClass(bill.tfr)}">TFR: <span class="status">${escapeHTML(bill.tfr || "Not set")}</span></span>
        <span class="badge ${bill.fiscal ? "support" : "neutral"}">Fiscal: ${bill.fiscal || "None"}</span>
      `;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div><strong>Committee Votes</strong><br>${formatMultiline(bill.committeeVotes || "—")}</div>
      `;

      card.appendChild(header);
      card.appendChild(badges);
      card.appendChild(meta);

      if (bill.notes) {
        const details = document.createElement("details");
        details.innerHTML = `
          <summary>Notes & endorsements</summary>
          <div>${formatMultiline(bill.notes)}</div>
        `;
        card.appendChild(details);
      }

      return card;
    }

    function renderCounts(data) {
      const total = data.length;
      const support = data.filter((item) => item.caucusClass === "support").length;
      const oppose = data.filter((item) => item.caucusClass === "oppose").length;
      const neutral = total - support - oppose;

      countsEl.innerHTML = `
        <span class="count-pill">Total: ${total}</span>
        <span class="count-pill">Support: ${support}</span>
        <span class="count-pill">Oppose: ${oppose}</span>
        <span class="count-pill">Neutral: ${neutral}</span>
      `;
    }

    function applyFilter(filter, data) {
      const cards = Array.from(gridEl.children);
      let visibleCount = 0;

      cards.forEach((card, index) => {
        const matches =
          filter === "all" || card.dataset.caucus === filter;
        card.hidden = !matches;
        if (matches) visibleCount += 1;
      });

      emptyEl.hidden = visibleCount !== 0;
    }

    function initFilters(data) {
      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          filterButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          applyFilter(button.dataset.filter, data);
        });
      });
    }

    async function init() {
      const text = INLINE_CSV || (await (await fetch(CSV_PATH)).text());
      const rows = parseCSV(text);

      const headerIndex = rows.findIndex((row) => (row[0] || "").trim() === "Bill");
      if (headerIndex === -1) {
        gridEl.innerHTML = "<div class=\"empty\">Header row not found in CSV.</div>";
        return;
      }

      const headers = rows[headerIndex].map((value) => value.trim());
      const data = [];

      for (let i = headerIndex + 1; i < rows.length; i += 1) {
        const row = rows[i];
        const billId = (row[0] || "").trim();

        if (!billId || billId === "Bill" || billId.startsWith("Page") || !BILL_RE.test(billId)) {
          continue;
        }

        const record = {};
        headers.forEach((header, index) => {
          record[header] = (row[index] || "").trim();
        });

        const caucus = cleanStatus(record.Caucus);
        data.push({
          bill: record.Bill || billId,
          author: record.Author || "—",
          committeeVotes: record["Committee Votes"] || "",
          fiscal: record.Fiscal || "",
          caucus,
          caucusClass: statusClass(caucus),
          tcc: cleanStatus(record.TCC),
          tfr: cleanStatus(record.TFR),
          notes: record.Notes || "",
        });
      }

      renderCounts(data);
      initFilters(data);
      gridEl.innerHTML = "";

      data.forEach((bill) => {
        gridEl.appendChild(buildCard(bill));
      });

      applyFilter("all", data);
    }

    init().catch(() => {
      gridEl.innerHTML = "<div class=\"empty\">Unable to load CSV data.</div>";
    });
  </script>
</body>
</html>
